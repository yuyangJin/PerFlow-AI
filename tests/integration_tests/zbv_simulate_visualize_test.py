'''
test Visualize the simulated trace of zerobubble
'''

from perflowai.parallel.pipeline_parallel.ppgraph import PipeCostConfig
from perflowai.parallel.pipeline_parallel.zerobubble import ZeroBubbleGraph, ScheduleType
from perflowai.simulator.pp_simulator import PPSimulator, PipeType
from perflowai.visualizer.trace_visualizer import TraceVisiualizer

stage_events_str = ['[<Event 240:F:0-0>, <Event 241:F:1-0>, <Event 242:F:2-0>, <Event 243:F:3-0>, <Event 244:F:4-0>, <Event 245:F:5-0>, <Event 246:F:6-0>, <Event 247:F:7-0>, <Event 300:F:0-1>, <Event 248:F:8-0>, <Event 420:B:0-1>, <Event 301:F:1-1>, <Event 249:F:9-0>, <Event 540:W:0-1>, <Event 421:B:1-1>, <Event 302:F:2-1>, <Event 250:F:10-0>, <Event 541:W:1-1>, <Event 422:B:2-1>, <Event 303:F:3-1>, <Event 251:F:11-0>, <Event 542:W:2-1>, <Event 304:F:4-1>, <Event 423:B:3-1>, <Event 252:F:12-0>, <Event 305:F:5-1>, <Event 424:B:4-1>, <Event 543:W:3-1>, <Event 253:F:13-0>, <Event 306:F:6-1>, <Event 425:B:5-1>, <Event 544:W:4-1>, <Event 254:F:14-0>, <Event 307:F:7-1>, <Event 426:B:6-1>, <Event 545:W:5-1>, <Event 360:B:0-0>, <Event 308:F:8-1>, <Event 427:B:7-1>, <Event 546:W:6-1>, <Event 480:W:0-0>, <Event 361:B:1-0>, <Event 309:F:9-1>, <Event 428:B:8-1>, <Event 547:W:7-1>, <Event 481:W:1-0>, <Event 362:B:2-0>, <Event 310:F:10-1>, <Event 429:B:9-1>, <Event 548:W:8-1>, <Event 482:W:2-0>, <Event 311:F:11-1>, <Event 430:B:10-1>, <Event 363:B:3-0>, <Event 549:W:9-1>, <Event 312:F:12-1>, <Event 431:B:11-1>, <Event 483:W:3-0>, <Event 364:B:4-0>, <Event 550:W:10-1>, <Event 313:F:13-1>, <Event 432:B:12-1>, <Event 484:W:4-0>, <Event 365:B:5-0>, <Event 551:W:11-1>, <Event 314:F:14-1>, <Event 433:B:13-1>, <Event 485:W:5-0>, <Event 366:B:6-0>, <Event 552:W:12-1>, <Event 434:B:14-1>, <Event 486:W:6-0>, <Event 367:B:7-0>, <Event 553:W:13-1>, <Event 368:B:8-0>, <Event 487:W:7-0>, <Event 554:W:14-1>, <Event 369:B:9-0>, <Event 488:W:8-0>, <Event 370:B:10-0>, <Event 489:W:9-0>, <Event 371:B:11-0>, <Event 490:W:10-0>, <Event 372:B:12-0>, <Event 491:W:11-0>, <Event 373:B:13-0>, <Event 492:W:12-0>, <Event 374:B:14-0>, <Event 493:W:13-0>, <Event 494:W:14-0>]',
                    '[<Event 255:F:0-0>, <Event 256:F:1-0>, <Event 257:F:2-0>, <Event 258:F:3-0>, <Event 259:F:4-0>, <Event 260:F:5-0>, <Event 315:F:0-1>, <Event 261:F:6-0>, <Event 316:F:1-1>, <Event 262:F:7-0>, <Event 317:F:2-1>, <Event 263:F:8-0>, <Event 435:B:0-1>, <Event 318:F:3-1>, <Event 264:F:9-0>, <Event 555:W:0-1>, <Event 436:B:1-1>, <Event 319:F:4-1>, <Event 265:F:10-0>, <Event 556:W:1-1>, <Event 437:B:2-1>, <Event 320:F:5-1>, <Event 266:F:11-0>, <Event 557:W:2-1>, <Event 321:F:6-1>, <Event 438:B:3-1>, <Event 267:F:12-0>, <Event 322:F:7-1>, <Event 558:W:3-1>, <Event 439:B:4-1>, <Event 268:F:13-0>, <Event 375:B:0-0>, <Event 323:F:8-1>, <Event 440:B:5-1>, <Event 559:W:4-1>, <Event 269:F:14-0>, <Event 495:W:0-0>, <Event 376:B:1-0>, <Event 324:F:9-1>, <Event 441:B:6-1>, <Event 560:W:5-1>, <Event 496:W:1-0>, <Event 377:B:2-0>, <Event 325:F:10-1>, <Event 442:B:7-1>, <Event 561:W:6-1>, <Event 497:W:2-0>, <Event 326:F:11-1>, <Event 378:B:3-0>, <Event 443:B:8-1>, <Event 562:W:7-1>, <Event 327:F:12-1>, <Event 498:W:3-0>, <Event 444:B:9-1>, <Event 379:B:4-0>, <Event 563:W:8-1>, <Event 328:F:13-1>, <Event 445:B:10-1>, <Event 499:W:4-0>, <Event 380:B:5-0>, <Event 564:W:9-1>, <Event 329:F:14-1>, <Event 446:B:11-1>, <Event 500:W:5-0>, <Event 381:B:6-0>, <Event 565:W:10-1>, <Event 447:B:12-1>, <Event 501:W:6-0>, <Event 382:B:7-0>, <Event 566:W:11-1>, <Event 448:B:13-1>, <Event 383:B:8-0>, <Event 502:W:7-0>, <Event 567:W:12-1>, <Event 449:B:14-1>, <Event 384:B:9-0>, <Event 503:W:8-0>, <Event 568:W:13-1>, <Event 385:B:10-0>, <Event 504:W:9-0>, <Event 569:W:14-1>, <Event 386:B:11-0>, <Event 505:W:10-0>, <Event 387:B:12-0>, <Event 506:W:11-0>, <Event 388:B:13-0>, <Event 507:W:12-0>, <Event 389:B:14-0>, <Event 508:W:13-0>, <Event 509:W:14-0>]',
                    '[<Event 270:F:0-0>, <Event 271:F:1-0>, <Event 272:F:2-0>, <Event 330:F:0-1>, <Event 273:F:3-0>, <Event 274:F:4-0>, <Event 331:F:1-1>, <Event 275:F:5-0>, <Event 332:F:2-1>, <Event 276:F:6-0>, <Event 333:F:3-1>, <Event 277:F:7-0>, <Event 334:F:4-1>, <Event 450:B:0-1>, <Event 278:F:8-0>, <Event 335:F:5-1>, <Event 570:W:0-1>, <Event 279:F:9-0>, <Event 451:B:1-1>, <Event 336:F:6-1>, <Event 280:F:10-0>, <Event 571:W:1-1>, <Event 452:B:2-1>, <Event 337:F:7-1>, <Event 390:B:0-0>, <Event 281:F:11-0>, <Event 572:W:2-1>, <Event 338:F:8-1>, <Event 453:B:3-1>, <Event 510:W:0-0>, <Event 282:F:12-0>, <Event 391:B:1-0>, <Event 339:F:9-1>, <Event 573:W:3-1>, <Event 454:B:4-1>, <Event 283:F:13-0>, <Event 511:W:1-0>, <Event 392:B:2-0>, <Event 340:F:10-1>, <Event 574:W:4-1>, <Event 455:B:5-1>, <Event 284:F:14-0>, <Event 512:W:2-0>, <Event 341:F:11-1>, <Event 393:B:3-0>, <Event 456:B:6-1>, <Event 575:W:5-1>, <Event 342:F:12-1>, <Event 513:W:3-0>, <Event 394:B:4-0>, <Event 457:B:7-1>, <Event 576:W:6-1>, <Event 343:F:13-1>, <Event 514:W:4-0>, <Event 458:B:8-1>, <Event 395:B:5-0>, <Event 577:W:7-1>, <Event 344:F:14-1>, <Event 459:B:9-1>, <Event 515:W:5-0>, <Event 396:B:6-0>, <Event 578:W:8-1>, <Event 460:B:10-1>, <Event 516:W:6-0>, <Event 397:B:7-0>, <Event 579:W:9-1>, <Event 461:B:11-1>, <Event 398:B:8-0>, <Event 517:W:7-0>, <Event 580:W:10-1>, <Event 462:B:12-1>, <Event 399:B:9-0>, <Event 518:W:8-0>, <Event 581:W:11-1>, <Event 463:B:13-1>, <Event 400:B:10-0>, <Event 519:W:9-0>, <Event 582:W:12-1>, <Event 464:B:14-1>, <Event 401:B:11-0>, <Event 520:W:10-0>, <Event 583:W:13-1>, <Event 402:B:12-0>, <Event 521:W:11-0>, <Event 584:W:14-1>, <Event 403:B:13-0>, <Event 522:W:12-0>, <Event 404:B:14-0>, <Event 523:W:13-0>, <Event 524:W:14-0>]',
                    '[<Event 285:F:0-0>, <Event 345:F:0-1>, <Event 286:F:1-0>, <Event 346:F:1-1>, <Event 287:F:2-0>, <Event 288:F:3-0>, <Event 347:F:2-1>, <Event 289:F:4-0>, <Event 348:F:3-1>, <Event 290:F:5-0>, <Event 349:F:4-1>, <Event 291:F:6-0>, <Event 350:F:5-1>, <Event 292:F:7-0>, <Event 351:F:6-1>, <Event 465:B:0-1>, <Event 293:F:8-0>, <Event 352:F:7-1>, <Event 585:W:0-1>, <Event 405:B:0-0>, <Event 466:B:1-1>, <Event 294:F:9-0>, <Event 353:F:8-1>, <Event 525:W:0-0>, <Event 586:W:1-1>, <Event 406:B:1-0>, <Event 295:F:10-0>, <Event 467:B:2-1>, <Event 354:F:9-1>, <Event 526:W:1-0>, <Event 296:F:11-0>, <Event 587:W:2-1>, <Event 407:B:2-0>, <Event 355:F:10-1>, <Event 468:B:3-1>, <Event 297:F:12-0>, <Event 527:W:2-0>, <Event 356:F:11-1>, <Event 408:B:3-0>, <Event 588:W:3-1>, <Event 469:B:4-1>, <Event 298:F:13-0>, <Event 357:F:12-1>, <Event 528:W:3-0>, <Event 409:B:4-0>, <Event 589:W:4-1>, <Event 470:B:5-1>, <Event 299:F:14-0>, <Event 358:F:13-1>, <Event 529:W:4-0>, <Event 410:B:5-0>, <Event 590:W:5-1>, <Event 471:B:6-1>, <Event 359:F:14-1>, <Event 530:W:5-0>, <Event 472:B:7-1>, <Event 411:B:6-0>, <Event 591:W:6-1>, <Event 473:B:8-1>, <Event 412:B:7-0>, <Event 531:W:6-0>, <Event 592:W:7-1>, <Event 474:B:9-1>, <Event 413:B:8-0>, <Event 532:W:7-0>, <Event 593:W:8-1>, <Event 475:B:10-1>, <Event 414:B:9-0>, <Event 533:W:8-0>, <Event 594:W:9-1>, <Event 476:B:11-1>, <Event 415:B:10-0>, <Event 534:W:9-0>, <Event 595:W:10-1>, <Event 477:B:12-1>, <Event 416:B:11-0>, <Event 535:W:10-0>, <Event 596:W:11-1>, <Event 478:B:13-1>, <Event 417:B:12-0>, <Event 536:W:11-0>, <Event 597:W:12-1>, <Event 479:B:14-1>, <Event 418:B:13-0>, <Event 537:W:12-0>, <Event 598:W:13-1>, <Event 419:B:14-0>, <Event 538:W:13-0>, <Event 599:W:14-1>, <Event 539:W:14-0>]']

def test_ZBV_Simulate_Visualize():
    g = ZeroBubbleGraph(4, 15, 2, cost_config = PipeCostConfig(
        fwd_time = 5478,
        bwd_time = 5806,
        wgt_time = 3534
    ), schedule_type = ScheduleType.ZBV)
    g.build_graph()

    sim = PPSimulator(PipeType.ZeroBubble, g)
    trace = sim.run()

    assert trace.get_nstages() == 4
    assert trace.get_nmicrobatches() == 15
    assert trace.get_nchunks() == 2

    for i in range(trace.get_nstages()):
        assert str(trace.get_events(i)) == stage_events_str[i]
        # print(trace.get_events(i))
    
    visualizer = TraceVisiualizer(trace)
    visualizer.visualize()

test_ZBV_Simulate_Visualize()