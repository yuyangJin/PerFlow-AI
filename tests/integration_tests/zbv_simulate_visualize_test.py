'''
test Visualize the simulated trace of zerobubble
'''

from perflowai.parallel.pipeline_parallel.ppgraph import PipeCostConfig
from perflowai.parallel.pipeline_parallel.zerobubble import ZeroBubbleGraph, ScheduleType
from perflowai.simulator.pp_simulator import PPSimulator, PipeType
from perflowai.visualizer.trace_visualizer import TraceVisiualizer

stage0_events_str = '[<Event 160:EventType.FWD-0-0>, <Event 161:EventType.FWD-1-0>, <Event 162:EventType.FWD-2-0>, <Event 163:EventType.FWD-3-0>, <Event 164:EventType.FWD-4-0>, <Event 165:EventType.FWD-5-0>, <Event 166:EventType.FWD-6-0>, <Event 167:EventType.FWD-7-0>, <Event 200:EventType.FWD-0-1>, <Event 168:EventType.FWD-8-0>, <Event 280:EventType.BWD-0-1>, <Event 201:EventType.FWD-1-1>, <Event 169:EventType.FWD-9-0>, <Event 360:EventType.WGT-0-1>, <Event 281:EventType.BWD-1-1>, <Event 202:EventType.FWD-2-1>, <Event 361:EventType.WGT-1-1>, <Event 282:EventType.BWD-2-1>, <Event 203:EventType.FWD-3-1>, <Event 362:EventType.WGT-2-1>, <Event 283:EventType.BWD-3-1>, <Event 204:EventType.FWD-4-1>, <Event 363:EventType.WGT-3-1>, <Event 284:EventType.BWD-4-1>, <Event 205:EventType.FWD-5-1>, <Event 364:EventType.WGT-4-1>, <Event 285:EventType.BWD-5-1>, <Event 206:EventType.FWD-6-1>, <Event 365:EventType.WGT-5-1>, <Event 286:EventType.BWD-6-1>, <Event 207:EventType.FWD-7-1>, <Event 240:EventType.BWD-0-0>, <Event 366:EventType.WGT-6-1>, <Event 208:EventType.FWD-8-1>, <Event 287:EventType.BWD-7-1>, <Event 320:EventType.WGT-0-0>, <Event 241:EventType.BWD-1-0>, <Event 209:EventType.FWD-9-1>, <Event 288:EventType.BWD-8-1>, <Event 367:EventType.WGT-7-1>, <Event 321:EventType.WGT-1-0>, <Event 242:EventType.BWD-2-0>, <Event 289:EventType.BWD-9-1>, <Event 368:EventType.WGT-8-1>, <Event 322:EventType.WGT-2-0>, <Event 243:EventType.BWD-3-0>, <Event 369:EventType.WGT-9-1>, <Event 323:EventType.WGT-3-0>, <Event 244:EventType.BWD-4-0>, <Event 324:EventType.WGT-4-0>, <Event 245:EventType.BWD-5-0>, <Event 325:EventType.WGT-5-0>, <Event 246:EventType.BWD-6-0>, <Event 326:EventType.WGT-6-0>, <Event 247:EventType.BWD-7-0>, <Event 327:EventType.WGT-7-0>, <Event 248:EventType.BWD-8-0>, <Event 328:EventType.WGT-8-0>, <Event 249:EventType.BWD-9-0>, <Event 329:EventType.WGT-9-0>]'
stage1_events_str = '[<Event 170:EventType.FWD-0-0>, <Event 171:EventType.FWD-1-0>, <Event 172:EventType.FWD-2-0>, <Event 173:EventType.FWD-3-0>, <Event 174:EventType.FWD-4-0>, <Event 175:EventType.FWD-5-0>, <Event 210:EventType.FWD-0-1>, <Event 176:EventType.FWD-6-0>, <Event 211:EventType.FWD-1-1>, <Event 177:EventType.FWD-7-0>, <Event 212:EventType.FWD-2-1>, <Event 178:EventType.FWD-8-0>, <Event 290:EventType.BWD-0-1>, <Event 213:EventType.FWD-3-1>, <Event 179:EventType.FWD-9-0>, <Event 370:EventType.WGT-0-1>, <Event 291:EventType.BWD-1-1>, <Event 214:EventType.FWD-4-1>, <Event 371:EventType.WGT-1-1>, <Event 292:EventType.BWD-2-1>, <Event 215:EventType.FWD-5-1>, <Event 372:EventType.WGT-2-1>, <Event 293:EventType.BWD-3-1>, <Event 216:EventType.FWD-6-1>, <Event 373:EventType.WGT-3-1>, <Event 294:EventType.BWD-4-1>, <Event 217:EventType.FWD-7-1>, <Event 250:EventType.BWD-0-0>, <Event 374:EventType.WGT-4-1>, <Event 218:EventType.FWD-8-1>, <Event 295:EventType.BWD-5-1>, <Event 330:EventType.WGT-0-0>, <Event 251:EventType.BWD-1-0>, <Event 219:EventType.FWD-9-1>, <Event 375:EventType.WGT-5-1>, <Event 296:EventType.BWD-6-1>, <Event 331:EventType.WGT-1-0>, <Event 252:EventType.BWD-2-0>, <Event 376:EventType.WGT-6-1>, <Event 297:EventType.BWD-7-1>, <Event 332:EventType.WGT-2-0>, <Event 253:EventType.BWD-3-0>, <Event 377:EventType.WGT-7-1>, <Event 298:EventType.BWD-8-1>, <Event 333:EventType.WGT-3-0>, <Event 254:EventType.BWD-4-0>, <Event 378:EventType.WGT-8-1>, <Event 299:EventType.BWD-9-1>, <Event 334:EventType.WGT-4-0>, <Event 255:EventType.BWD-5-0>, <Event 379:EventType.WGT-9-1>, <Event 335:EventType.WGT-5-0>, <Event 256:EventType.BWD-6-0>, <Event 336:EventType.WGT-6-0>, <Event 257:EventType.BWD-7-0>, <Event 337:EventType.WGT-7-0>, <Event 258:EventType.BWD-8-0>, <Event 338:EventType.WGT-8-0>, <Event 259:EventType.BWD-9-0>, <Event 339:EventType.WGT-9-0>]'
stage2_events_str = '[<Event 180:EventType.FWD-0-0>, <Event 181:EventType.FWD-1-0>, <Event 182:EventType.FWD-2-0>, <Event 183:EventType.FWD-3-0>, <Event 220:EventType.FWD-0-1>, <Event 184:EventType.FWD-4-0>, <Event 221:EventType.FWD-1-1>, <Event 185:EventType.FWD-5-0>, <Event 222:EventType.FWD-2-1>, <Event 186:EventType.FWD-6-0>, <Event 223:EventType.FWD-3-1>, <Event 187:EventType.FWD-7-0>, <Event 224:EventType.FWD-4-1>, <Event 188:EventType.FWD-8-0>, <Event 300:EventType.BWD-0-1>, <Event 225:EventType.FWD-5-1>, <Event 189:EventType.FWD-9-0>, <Event 380:EventType.WGT-0-1>, <Event 301:EventType.BWD-1-1>, <Event 226:EventType.FWD-6-1>, <Event 381:EventType.WGT-1-1>, <Event 302:EventType.BWD-2-1>, <Event 227:EventType.FWD-7-1>, <Event 260:EventType.BWD-0-0>, <Event 382:EventType.WGT-2-1>, <Event 228:EventType.FWD-8-1>, <Event 303:EventType.BWD-3-1>, <Event 340:EventType.WGT-0-0>, <Event 261:EventType.BWD-1-0>, <Event 229:EventType.FWD-9-1>, <Event 383:EventType.WGT-3-1>, <Event 304:EventType.BWD-4-1>, <Event 341:EventType.WGT-1-0>, <Event 262:EventType.BWD-2-0>, <Event 384:EventType.WGT-4-1>, <Event 305:EventType.BWD-5-1>, <Event 342:EventType.WGT-2-0>, <Event 263:EventType.BWD-3-0>, <Event 385:EventType.WGT-5-1>, <Event 306:EventType.BWD-6-1>, <Event 343:EventType.WGT-3-0>, <Event 264:EventType.BWD-4-0>, <Event 386:EventType.WGT-6-1>, <Event 307:EventType.BWD-7-1>, <Event 344:EventType.WGT-4-0>, <Event 265:EventType.BWD-5-0>, <Event 387:EventType.WGT-7-1>, <Event 308:EventType.BWD-8-1>, <Event 345:EventType.WGT-5-0>, <Event 266:EventType.BWD-6-0>, <Event 388:EventType.WGT-8-1>, <Event 309:EventType.BWD-9-1>, <Event 346:EventType.WGT-6-0>, <Event 389:EventType.WGT-9-1>, <Event 267:EventType.BWD-7-0>, <Event 347:EventType.WGT-7-0>, <Event 268:EventType.BWD-8-0>, <Event 348:EventType.WGT-8-0>, <Event 269:EventType.BWD-9-0>, <Event 349:EventType.WGT-9-0>]'
stage3_events_str = '[<Event 190:EventType.FWD-0-0>, <Event 230:EventType.FWD-0-1>, <Event 191:EventType.FWD-1-0>, <Event 192:EventType.FWD-2-0>, <Event 231:EventType.FWD-1-1>, <Event 193:EventType.FWD-3-0>, <Event 232:EventType.FWD-2-1>, <Event 194:EventType.FWD-4-0>, <Event 233:EventType.FWD-3-1>, <Event 195:EventType.FWD-5-0>, <Event 234:EventType.FWD-4-1>, <Event 196:EventType.FWD-6-0>, <Event 235:EventType.FWD-5-1>, <Event 197:EventType.FWD-7-0>, <Event 236:EventType.FWD-6-1>, <Event 310:EventType.BWD-0-1>, <Event 198:EventType.FWD-8-0>, <Event 237:EventType.FWD-7-1>, <Event 390:EventType.WGT-0-1>, <Event 270:EventType.BWD-0-0>, <Event 199:EventType.FWD-9-0>, <Event 238:EventType.FWD-8-1>, <Event 311:EventType.BWD-1-1>, <Event 350:EventType.WGT-0-0>, <Event 239:EventType.FWD-9-1>, <Event 391:EventType.WGT-1-1>, <Event 271:EventType.BWD-1-0>, <Event 312:EventType.BWD-2-1>, <Event 351:EventType.WGT-1-0>, <Event 272:EventType.BWD-2-0>, <Event 392:EventType.WGT-2-1>, <Event 313:EventType.BWD-3-1>, <Event 352:EventType.WGT-2-0>, <Event 273:EventType.BWD-3-0>, <Event 393:EventType.WGT-3-1>, <Event 314:EventType.BWD-4-1>, <Event 353:EventType.WGT-3-0>, <Event 274:EventType.BWD-4-0>, <Event 394:EventType.WGT-4-1>, <Event 315:EventType.BWD-5-1>, <Event 354:EventType.WGT-4-0>, <Event 275:EventType.BWD-5-0>, <Event 395:EventType.WGT-5-1>, <Event 316:EventType.BWD-6-1>, <Event 355:EventType.WGT-5-0>, <Event 396:EventType.WGT-6-1>, <Event 276:EventType.BWD-6-0>, <Event 317:EventType.BWD-7-1>, <Event 356:EventType.WGT-6-0>, <Event 277:EventType.BWD-7-0>, <Event 318:EventType.BWD-8-1>, <Event 397:EventType.WGT-7-1>, <Event 357:EventType.WGT-7-0>, <Event 278:EventType.BWD-8-0>, <Event 319:EventType.BWD-9-1>, <Event 398:EventType.WGT-8-1>, <Event 358:EventType.WGT-8-0>, <Event 279:EventType.BWD-9-0>, <Event 399:EventType.WGT-9-1>, <Event 359:EventType.WGT-9-0>]'

def test_GPipe_Simulate_Visualize():
    g = ZeroBubbleGraph(4, 10, 2, cost_config = PipeCostConfig(
        fwd_time = 5478,
        bwd_time = 5806,
        wgt_time = 3534
    ), schedule_type = ScheduleType.ZBV)
    g.build_graph()

    sim = PPSimulator(PipeType.ZeroBubble, g)
    trace = sim.run()

    assert stage0_events_str == str(trace.get_events(0))
    assert stage1_events_str == str(trace.get_events(1))
    assert stage2_events_str == str(trace.get_events(2))
    assert stage3_events_str == str(trace.get_events(3))
    
    visualizer = TraceVisiualizer(trace)
    visualizer.visualize()